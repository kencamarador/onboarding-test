on:
  repository_dispatch:
  
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Echo Key
        env:
          KEY: ${{ github.event.client_payload.key }}
          FIRSTNAME: ${{ github.event.client_payload.firstname }}
          LASTNAME: ${{ github.event.client_payload.lastname }}
          ACCESSTOKENSECURE: ${{ secrets.accessTokenSecure }}
          
        run: |
          $accessTokenSecure = ConvertTo-SecureString -String $env:ACCESSTOKENSECURE -AsPlainText -Force

          Connect-MgGraph -AccessToken $accessTokenSecure

          $UPN = "$($FirstName).$($LastName)@kencamarador.com"

          $params = @{
            accountEnabled = $true
            displayName = "$FIRSTNAME $LASTNAME"
            mailNickname = "AdeleV"
            userPrincipalName = "$UPN"
            passwordProfile = @{
              forceChangePasswordNextSignIn = $true
              password = "xWwvJ]6NMw+bWH-d"
            }
          }

          New-MgUser -BodyParameter $params